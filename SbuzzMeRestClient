var ServerKey = "AIzaSyAxtVQJmqmsKAOIdHszjDMVxjEQHKMSe-w";
var https = require('https');
var logger = require('./log.js');
var crypto = require('crypto')



module.exports = {

    sbuzz : function  (listContacts, origin, sbuzzid, chatid) {
        var current_date = (new Date()).valueOf().toString();
        var random = Math.random().toString();
        var id = crypto.createHash('sha1').update(current_date + random).digest('hex');
        console.log("id="+id);

        logger.log(listContacts)
        var stringContacts= listContacts;
        var stringMsg = JSON.stringify({
            "registration_ids" : listContacts,
            "collapse_key" : id,
            "from" : origin,
            "data" : {
                "from_" : origin,
                "type_" : "sbuzz"
            }
        });
        var postheaders = {
            'Content-Type' : 'application/json',
            'Authorization' : 'key='+ServerKey,
            'Content-Length' : Buffer.byteLength(stringMsg, 'utf8')
        };

        var optionspost = {
            host : 'android.googleapis.com', // here only the domain name
            // (no http/https !)
            port : 443,
            path : '/gcm/send', // the rest of the url with parameters if needed
            method : 'POST', // do GET
            headers : postheaders
        };

        var reqPost = https.request(optionspost, function(res) {
            res.on('data', function(d) {
                process.stdout.write(d);
            });
        });
        reqPost.write(stringMsg);
        reqPost.end();
        reqPost.on('error', function(e) {
            logger.log(e);
            return 0;
        });
        return id;

    }
}
